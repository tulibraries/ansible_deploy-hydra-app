Listen 443

{% if  ansible_os_family == "RedHat" and ansible_distribution_major_version == "7" %}
SSLSessionCache         shmcb:/var/cache/mod_ssl/scache(512000)
SSLSessionCacheTimeout  300
{% endif %}


{% if  ansible_os_family == "RedHat" and ansible_distribution_major_version == "7" %}
SSLRandomSeed startup file:/dev/urandom  256
SSLRandomSeed connect builtin
SSLCryptoDevice builtin
{% endif %}

{% if  ansible_os_family == "RedHat" and ansible_distribution_major_version == "6" %}
LoadModule ssl_module modules/mod_ssl.so
{% endif %}

<VirtualHost *:443>

  {% if fqdn  %}
  ServerName {{fqdn}}
  {% endif %}

  ErrorLog logs/ssl_error_log
  TransferLog logs/ssl_access_log
  LogLevel warn

  SSLEngine on
  SSLProtocol All -SSLv2 -SSLv3
  SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:DHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES128-SHA:AES256-SHA256:AES256-SHA:DES-CBC3-SHA
  SSLHonorCipherOrder On

  SSLCertificateFile {{ app_ssl_cert_path }}
  SSLCertificateKeyFile {{ app_ssl_key_path }}
  {% if app_use_intermediate_cert %}SSLCACertificateFile {{ app_ssl_intermediate_path }}{% endif %}
  
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
  Header always set X-Frame-Options DENY
  Header always set X-Content-Type-Options nosniff
 
CustomLog logs/ssl_request_log \
          "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"

  
  DocumentRoot /var/www/html
  PassengerRuby /usr/bin/ruby

  {% if app_set_root_redirect %}}
  RedirectMatch ^/$ {{ app_root_redirect }}
  {% endif %}

  #include app specific configs in the applications directory
  Include conf.d/applications/*.conf-fragment


</VirtualHost>
